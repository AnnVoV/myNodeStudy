<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>test title</title>
  <!-- 加载Traceur编译器 -->
  <!--<script src="http://google.github.io/traceur-compiler/bin/traceur.js"
          type="text/javascript"></script>-->
  <!-- 将Traceur编译器用于网页 -->
  <!--<script src="http://google.github.io/traceur-compiler/src/bootstrap.js"
          type="text/javascript"></script>-->
  <script src="../js/comm/traceur.js"></script>
  <script src="../js/comm/bootstrap.js"></script>
</head>
<body>
  <div>Promise 发起多个XHR请求</div>
  <div>Sth About Ann:</div>
  <div>
    <div>这是第一个请求:</div>
    <ul id="list">
    </ul>
  </div>
  <div>
    <div>这是第二个请求:</div>
    <div id="list2">
    </div>
  </div>
  <script type="module">
    'use strict';
    //dom 集合
    var dom = {
      list:document.getElementById('list'),
      list2:document.getElementById('list2')
    };

    //ajax 请求-> 共同的处理部分
    var ajaxHandler = function(url,callback){
      var req = new XMLHttpRequest();
      req.open('GET',url,true);
      req.onload = function(){
        if(this.status === 200){
          callback(null,this.responseText);  
        }
      };
      req.onerror = function(err){
        callback(err,req.statusText);
      };
      req.send();
      //我们在这里:error的时候调用错误的handler
      //我们在这里:success的时候调用成功的handler
    };

    //发起多个ajax请求的对象
    var request = {
      ajaxData1:function(url,callback){
        ajaxHandler(url,callback);
      },
      ajaxData2:function(url,callback){
        ajaxHandler(url,callback);
      }
    };

    //看能不能把callBackHandler1与callBackHandler2中
    //共同的部分取出来写成共同的
    var callBackHandler = function(detailCallBack,err,data){
      if(err){
        //出错了的相关处理
        console.log('请求出错了....');
        console.log(err);
      }else{
        console.log('请求成功....');
        detailCallBack(null,data);
      }
    };

    //第一个处理函数
    var callBackHandler1 = function(err,data){
      //最终的与处理相关的步骤都放在这里
      //这里要处理错误的与正常的两部分
      if(err){
        //如果出错了 显示错误的信息
        console.log('请求出错了....');
        console.log(data);
      }else{
        //正常处理进行相应的操作
        console.log('数据处理正常....');
        var ul = dom.list,
            jsonData = JSON.parse(data);

        for(var key in jsonData){
          var li = document.createElement('li'),
              text = key+':'+jsonData[key],
              textNode = document.createTextNode(text),
              brNode = document.createElement('br');

          ul.appendChild(textNode);
          ul.appendChild(brNode);
        }
      } 
    }

    var callBackHandler2 = function(err,data){
      if(err){
        //如果出错了 显示错误的信息
        console.log('请求出错了....');
        console.log(data);
      }else{
        //正常处理进行相应的操作
        console.log('进行处理正常....');
        var ul2 = dom.list2,
            content = document.createElement('div');

        content.innerHTML = data;
        ul2.appendChild(content);       
      }
    }

  //主函数脚本
  var main = function(){
    //callBackHandler(detailCallBack,err,data)
    //var func = callBackHandler.bind(null,callBackHandler1,null,);
    //request.ajaxData('/mockData1',);
      request.ajaxData1('/mockData1',callBackHandler1);
      request.ajaxData2('/mockData2',callBackHandler2);
  };
  //主函数
  main();
  </script>
</body>
</html>