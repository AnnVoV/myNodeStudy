<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>promise js</title>
  <script src="../js/comm/traceur.js"></script>
  <script src="../js/comm/bootstrap.js"></script>
</head>
<body>
  <script type="module">
    var NanShen = {
      height:180,
      weight:80,
      salary:'200k',
      request:function(obj){
        //成功与否随机决定
        var random = Math.random();
        console.log('random:',random);
        if(random>0.7){
          //成功的概率为50%
          obj.success();
        }else{
          //失败的概率为20%
          obj.error();
        }
      }
    };

    var Request = function(name){
      return new Promise(function(resolve,reject){
        var failed = 0,
            request = function(){
              NanShen.request(
                {
                  name:'Mr.X',
                  success:function(){
                    console.log(name+'攻略成功!');
                    failed = 0;
                    //成功的话直接调用resolve() 方法
                    resolve();
                  },
                  error:function(){
                    if(failed == 0){
                      console.log('第一次攻略'+name+'失败，重试一次！');
                      failed = 1;
                      //调用如果成功对应的方法
                      request();
                    }else{
                      console.log('依然没有成功!');
                      failed++;
                      //调用如果失败对应的方法
                      reject();
                    }
                  }
                }
              );
            };

        request();//发起请求
      });
    };
    //发起向daddy的请求
    Request('daddy')
    .then(function(){return Request('mummy');},function(){console.log('daddy最终拒绝!');return false;//如果return false 就不接着往下面执行了})
    .then(function(){return Request('girl');},function(){console.log('mummy最终拒绝!');
      return false;})
    .then(function(){console.log('最终成功!');},function(){console.log('最终失败!');});
  </script>
</body>
</html>